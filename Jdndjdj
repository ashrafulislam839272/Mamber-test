import logging
from typing import List

from telegram import (
    Update,
    InlineKeyboardButton,
    InlineKeyboardMarkup,
)
from telegram.ext import (
    ApplicationBuilder,
    CommandHandler,
    ContextTypes,
    MessageHandler,
    CallbackQueryHandler,
    filters,
)

# ================== CONFIG ==================

BOT_TOKEN = "8186051880:AAH1-KG_3g9fC7Ny4FrB7XGKBz0AXv06R8U"

#Your Channel Usernames
REQUIRED_CHANNELS: List[str] = [
    "@DARK_WEB_OVER_POWER",
    "@BLACK_DRAGON_OVER_POWER",
]

# Auto ban system 
BANNED_USERS = set()

# ================== LOGGING ==================

logging.basicConfig(
    format="%(asctime)s - %(name)s - %(levelname)s - %(message)s", level=logging.INFO
)
logger = logging.getLogger(__name__)


# ================== HELPER FUNCTIONS ==================

async def is_user_in_all_channels(user_id: int, context: ContextTypes.DEFAULT_TYPE) -> bool:
    """
  
    """
    for channel in REQUIRED_CHANNELS:
        try:
            member = await context.bot.get_chat_member(chat_id=channel, user_id=user_id)
            status = member.status  # "member", "administrator", "creator", "left", "kicked"
            if status not in ["member", "administrator", "creator"]:
                return False
        except Exception as e:
            logger.error(f"Error checking membership for {channel}: {e}")
            return False
    return True


async def is_user_left_any_channel(user_id: int, context: ContextTypes.DEFAULT_TYPE) -> bool:
    """
   
    """
    for channel in REQUIRED_CHANNELS:
        try:
            member = await context.bot.get_chat_member(chat_id=channel, user_id=user_id)
            if member.status in ["left", "kicked"]:
                return True
        except Exception as e:
            logger.error(f"Error checking leave status for {channel}: {e}")
            
            return True
    return False


def join_channels_keyboard() -> InlineKeyboardMarkup:
    """
    Join Caption
    """
    buttons = [
        [InlineKeyboardButton(text="üì¢ Channel 1", url="https://t.me/BLACK_DRAGON_OVER_POWER")],
        [InlineKeyboardButton(text="üì¢ Channel 2", url="https://t.me/DARK_WEB_OVER_POWER")],
        [InlineKeyboardButton(text="‚úÖ Joined ‡¶ï‡¶∞‡ßá‡¶õ‡¶ø", callback_data="check_subscriptions")],
    ]
    return InlineKeyboardMarkup(buttons)


# ================== HANDLERS ==================

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = update.effective_user
    user_id = user.id

    # Ban check
    if user_id in BANNED_USERS:
        await update.message.reply_text("üö´ ‡¶Ü‡¶™‡¶®‡¶ø ‡¶è‡¶á bot ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶•‡ßá‡¶ï‡ßá BAN ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡¶®‡•§")
        return

    # Channel membership check
    in_all = await is_user_in_all_channels(user_id, context)
    if not in_all:
        await update.message.reply_text(
            "üîí ‡¶è‡¶á bot ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶§‡ßá ‡¶Ü‡¶ó‡ßá ‡¶®‡¶ø‡¶ö‡ßá‡¶∞ ‡¶¶‡ßÅ‡¶á‡¶ü‡¶æ channel-‡¶è join ‡¶ï‡¶∞‡ßÅ‡¶®:",
            reply_markup=join_channels_keyboard(),
        )
        return

    # ‡¶∏‡¶¨ ‡¶†‡¶ø‡¶ï ‡¶•‡¶æ‡¶ï‡¶≤‡ßá main ‡¶ï‡¶æ‡¶ú ‡¶∂‡ßÅ‡¶∞‡ßÅ
    await update.message.reply_text(
        f"‚úÖ Welcome {user.first_name}!\n‡¶Ü‡¶™‡¶®‡¶ø ‡¶∏‡¶¨ channel join ‡¶ï‡¶∞‡ßá‡¶õ‡ßá‡¶®, ‡¶è‡¶ñ‡¶® bot use ‡¶ï‡¶∞‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶¨‡ßá‡¶®‡•§"
    )
    #main feature (custom code)


async def check_subscriptions_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """
    User '‚úÖ Joined ‡¶ï‡¶∞‡ßá‡¶õ‡¶ø' button ‡¶ö‡¶æ‡¶™‡¶≤‡ßá ‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡¶¨‡ßá subscription
    """
    query = update.callback_query
    await query.answer()

    user = query.from_user
    user_id = user.id

    # Ban check
    if user_id in BANNED_USERS:
        await query.edit_message_text("üö´ ‡¶Ü‡¶™‡¶®‡¶ø ‡¶è‡¶á bot ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶•‡ßá‡¶ï‡ßá BAN ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡¶®‡•§")
        return

    in_all = await is_user_in_all_channels(user_id, context)
    if not in_all:
        await query.edit_message_text(
            "‚ùå ‡¶è‡¶ñ‡¶®‡ßã ‡¶∏‡¶¨ channel join ‡¶ï‡¶∞‡ßá‡¶®‡¶®‡¶ø!\n‡¶¶‡ßü‡¶æ ‡¶ï‡¶∞‡ßá join ‡¶ï‡¶∞‡ßá ‡¶Ü‡¶¨‡¶æ‡¶∞ `‚úÖ Joined ‡¶ï‡¶∞‡ßá‡¶õ‡¶ø` ‡¶ö‡¶æ‡¶™‡ßÅ‡¶®‡•§",
            reply_markup=join_channels_keyboard(),
        )
        return

    await query.edit_message_text(
        "‚úÖ ‡¶∏‡¶¨ channel join complete!\n‡¶è‡¶ñ‡¶® `/start` ‡¶¶‡¶ø‡ßü‡ßá bot use ‡¶ï‡¶∞‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡ßá‡¶®‡•§"
    )


async def main_message_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """
   
    """
    user = update.effective_user
    user_id = user.id

    # Ban check
    if user_id in BANNED_USERS:
        # ‡¶ï‡¶ø‡¶õ‡ßÅ‡¶á reply ‡¶ï‡¶∞‡¶¨‡ßá ‡¶®‡¶æ, ‡¶è‡¶ï‡¶¶‡¶Æ silent ignore
        return

    # Channel ‡¶•‡ßá‡¶ï‡ßá left ‡¶¶‡¶ø‡ßü‡ßá‡¶õ‡ßá ‡¶ï‡¶ø‡¶®‡¶æ ‡¶ö‡ßá‡¶ï
    left_any = await is_user_left_any_channel(user_id, context)
    if left_any:
        BANNED_USERS.add(user_id)
        await update.message.reply_text(
            "üö´ ‡¶Ü‡¶™‡¶®‡¶ø ‡¶Ü‡¶Æ‡¶æ‡¶¶‡ßá‡¶∞ channel ‡¶•‡ßá‡¶ï‡ßá leave ‡¶¶‡¶ø‡ßü‡ßá‡¶õ‡ßá‡¶®, ‡¶§‡¶æ‡¶á ‡¶Ü‡¶™‡¶®‡¶æ‡¶ï‡ßá bot ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶•‡ßá‡¶ï‡ßá BAN ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§"
        )
        return

    # Channel join ‡¶ï‡¶∞‡ßá‡¶®‡¶ø ‡¶ï‡¶ø‡¶®‡¶æ ‡¶ö‡ßá‡¶ï
    in_all = await is_user_in_all_channels(user_id, context)
    if not in_all:
        await update.message.reply_text(
            "üîí ‡¶Ü‡¶ó‡ßá ‡¶Ü‡¶Æ‡¶æ‡¶¶‡ßá‡¶∞ channel ‡¶ó‡ßÅ‡¶≤‡ßã join ‡¶ï‡¶∞‡ßÅ‡¶®, ‡¶§‡¶æ‡¶∞‡¶™‡¶∞ bot ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶¨‡ßá‡¶®‡•§",
            reply_markup=join_channels_keyboard(),
        )
        return

    # ======================
    #simple echo:
    # ======================
    text = update.message.text or ""
    await update.message.reply_text(f"‡¶§‡ßÅ‡¶Æ‡¶ø ‡¶≤‡¶ø‡¶ñ‡ßá‡¶õ‡ßã: {text}")


# ================== MAIN APP ==================

def main():
    app = ApplicationBuilder().token(BOT_TOKEN).build()

    # /start command
    app.add_handler(CommandHandler("start", start))

    # Subscription check callback
    app.add_handler(CallbackQueryHandler(check_subscriptions_callback, pattern="^check_subscriptions$"))

    # Global message handler
    app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, main_message_handler))

    app.run_polling()


if __name__ == "__main__":
    main()
